var test = require('tap').test,
    http = require('http'),
    express = require('express'),
    request = require('request'),
    through = require('through'),
    serve = require('./');

function createServer(options, callback) {
    var server = http.createServer(serve(options));
    handleServer(server, callback);
}

function createExpressServer(options, callback) {
    var app = express().use(serve(options)),
        server = http.createServer(app);
    handleServer(server, callback);
}

function handleServer(server, callback) {
    server.listen(0, function(err) {
        if (err) {
            return callback(err);
        }

        var url = 'http://localhost:' + server.address().port + '/';
        callback(null, server, url);
    });
}

function testScript(options, script, t) {
    createServer(options, function(err, server, url) {
        t.notOk(err);

        request(url + 'script.js', function(err, r, body) {
            t.notOk(err);
            t.equal(r.statusCode, 200);
            t.equal(body, script);

            server.close(function() {
                t.end();
            });
        });
    });
}

test('serve home page', function(t) {
    createServer({ src: '' }, function(err, server, url) {
        t.notOk(err);
        request(url, function(err, r, body) {
            t.notOk(err);
            t.equal(r.statusCode, 200);
            t.equal(body.indexOf('<!DOCTYPE html>'), 0);
            t.notEqual(body.indexOf('<div id="output"'), -1);
            t.notEqual(body.indexOf('(funct