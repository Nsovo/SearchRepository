var split = require('split2');
var through = require('through2');
var combine = require('stream-combiner2');
var fs = require('fs');

module.exports = function (cb) {
    var files = {};
    var counts = {};
    var original = {};
    
    return combine(split(), through(write, end));

    function write (line, enc, next) {
        var m;
        if (m = /^COVERAGE\s+("[^"]+"|\S+)\s+(\S+)/.exec(line)) {
            var file = m[1], ranges = m[2];
            if (/^"/.test(file) && /"$/.test(file)) file = JSON.parse(file);
            files[file] = JSON.parse(ranges);
            original[file] = JSON.parse(ranges).filter(Boolean);
        }
        else if (m = /^COVERED\s+("[^"]+"|\S+)\s+(\S+)/.exec(line)) {
            var file = m[1], index = m[2];
            if (/^"/.test(file) && /"$/.test(file)) file = JSON.parse(file);
            delete files[file][index];
        }
        else this.push(line + '\n');
        next();
    }
    
    function end () {
        var ranges = Object.keys(files).reduce(fun