"use strict";
var $__Object = Object,
    $__getOwnPropertyNames = $__Object.getOwnPropertyNames,
    $__getOwnPropertyDescriptor = $__Object.getOwnPropertyDescriptor,
    $__getDescriptors = function(object) {
      var descriptors = {},
          name,
          names = $__getOwnPropertyNames(object);
      for (var i = 0; i < names.length; i++) {
        var name = names[i];
        descriptors[name] = $__getOwnPropertyDescriptor(object, name);
      }
      return descriptors;
    },
    $__createClassNoExtends = function(object, staticObject) {
      var ctor = object.constructor;
      Object.defineProperty(object, 'constructor', {enumerable: false});
      ctor.prototype = object;
      Object.defineProperties(ctor, $__getDescriptors(staticObject));
      return ctor;
    };
var _ = require("underscore");
var fs = require("fs");
var Path = require("path");
var Compiler = require("es6-module-transpiler").Compiler;
var LocalsCompiler = require("./locals-compiler")["default"];
var Packager = function() {
  'use strict';
  var $Packager = ($__createClassNoExtends)({
    constructor: function(file) {
      var options = arguments[1] !== (void 0) ? arguments[1]: {};
      this.requestedName = file;
      this.file = Path.resolve(file);
      this.loadedModules = {};
      this.fileList = [];
      this.options = options;
      this.options.imports = {};
      this.unique = 0;
      this.collectDependencies();
    },
    collectDependencies: function() {
      var file = arguments[0] !== (void 0) ? arguments[0]: this.file;
      var requested = arguments[1] !== (void 0) ? arguments[1]: this.requestedName;
      var parent = arguments[2] !== (void 0) ? arguments[2]: this.file;
      file = file.replace(/\.js$/, '') + '.js';
      this.loadedModules[file] = false;
      this.options.imports[file] = ("__module" + this.unique++ + "__");
      var source,
          compiler;
      try {
        source = fs.readFileSync(file);
      } catch (err) {
        throw new Error(("Unable to lookup \"" + requested + "\" from \"" + parent + "\""));
      }
      compiler = new Compiler(source, file, this.options);
      compiler.imports.forEach(function(importStatement) {
        var name = importStatement.source.value,
            path = Path.resolve(Path.dirname(file), name);
        path = path.replace(/\.js$/, '') + '.js';
        if (this.loadedModules[path] === false) {
          throw new Error(("Circular dependency found \"" + importStatement.source.value + "\" in \"" + file + "\""));
        } else if (!this.loadedModules[path]) {
          this.collectDependencies(path, name, file);
          this.checkImports(path, importStatement);
        }
      }, this);
      this.loadedModules[file] = compiler;
      this.fileList.push(file);
      return this.fileList;
    },
    toLocals: function() {
      var modules = this.loadedModules,
          options = this.options,
          root = Path.dirname(this.file);
      var out = this.options['export'] ? ("/* exported " + this.options['export'] + " */\nthis." + this.options['export'] + " = "): '';
      out += '(function() {\n';
      out += this.fileList.map(function(file) {
        var compiler = modules[file];
        return ("// " + Path.relative(root, file) + "\n" + new LocalsCompiler(compiler, options).stringify());
      }).join('\n');
      if (this.options['export']) {
        out += '\n  return __module0__;';
      }
      out += '\n})();\n';
      return out;
    },
    toUMD: function() {
      var modules = this.loadedModules,
          options = this.options,
          root = Path.dirname(this.file);
      var out = this.options['export'] ? ("/* exported " + this.options['export'] + " */\n(function (root, factory) {\n  if (typeof define === 'function' && define.amd) {\n    define([], factory);\n  } else if (typeof exports === 'object') {\n    module.exports = factory();\n  } else {\n    root." + this.options['export'] + " = factory();\n  }\n}(this, function () {\n"): '(function() {\n';
      out += this.fileList.map(function(file) {
        var compiler = modules[file];
        return ("// " + Path.relative(root, file) + "\n" + new LocalsCompiler(compiler, options).stringify());
      }).join('\n');
      if (this.options['export']) {
        out += '\n  return __module0__;\n}));\n';
      } else {
        out += '\n})();\n';
      }
      return out;
    },
    checkImports: function(name, importStatement) {
      var imported = this.loadedModules[name],
          exports = imported.exports;
      if (importStatement.kind === 'default') {
        if (!_.any(exports, function(export_) {
          return export_['default'];
        })) {
          throw new Error(("No default export for \"" + name + "\""));
        }
      } else if (importStatement.kind === 'named') {
        _.each(importStatement.specifiers, function(specifier) {
          var specifierName = specifier.id.name;
          var exported = _.any(exports, function(export_) {
            if (export_.specifiers) {
              return _.any(export_.specifiers, function(exportSpecifier) {
                return exportSpecifier.id.name === specifierName;
              });
            } else if (export_.declaration) {
              if (export_.declaration.type === 'VariableDeclaration') {
                return export_.declaration.declarations[0].id.name === specifierName;
              } else if (export_.declaration.type === 'FunctionDeclaration') {
                return export_.declaration.id.name === specifierName;
              } else if (export_.declaration.type === 'Indentifier') {
                return export_.declaration.name === specifierName;
              }
            }
          });
          if (!exported) {
            throw new Error(("No export named \"" + specifierName + "\" in \"" + name + "\""));
          }
        });
      }
    }
  }, {});
  return $Packager;
}();
exports["default"] = Packager;

//@ sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG1wL3RyYW5zcGlsZWQvbGliL3BhY2thZ2VyLmpzLmVzNiIsInNvdXJjZXMiOlsidG1wL3RyYW5zcGlsZWQvbGliL3BhY2thZ2VyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUNJLEdBQUEsRUFBQSxFQUFJLFFBQU8sQ0FBQyxZQUFBLENBQUE7QUFDWixHQUFBLEdBQUEsRUFBSyxRQUFPLENBQUMsSUFBQSxDQUFBO0FBQ2IsR0FBQSxLQUFBLEVBQU8sUUFBTyxDQUFDLE1BQUEsQ0FBQTtBQUNmLEdBQUEsU0FBQSxFQUFXLFFBQU8sQ0FBQyx1QkFBQSxDQUFBLENBQUEsUUFBQTtBQUNuQixHQUFBLGVBQUEsRUFBaUIsUUFBTyxDQUFDLG1CQUFBLENBQUEsQ0FBcUIsU0FBQSxDQUFBO0dBRTVDLFNBQUE7OztBQUNKLGVBQUEsQ0FBQSxTQUFBLENBQVksSUFBQSxDQUFvQjtTQUFkLFFBQUEsNENBQVUsRUFBQSxDQUFBO0FBQzFCLFVBQUEsQ0FBQSxhQUFBLEVBQXFCLEtBQUE7QUFDckIsVUFBQSxDQUFBLElBQUEsRUFBWSxLQUFBLENBQUEsT0FBWSxDQUFDLElBQUEsQ0FBQTtBQUV6QixVQUFBLENBQUEsYUFBQSxFQUFxQixFQUFBLENBQUE7QUFDckIsVUFBQSxDQUFBLFFBQUEsRUFBZ0IsRUFBQSxDQUFBO0FBRWhCLFVBQUEsQ0FBQSxPQUFBLEVBQWUsUUFBQTtBQUNmLFVBQUEsQ0FBQSxPQUFBLENBQUEsT0FBQSxFQUF1QixFQUFBLENBQUE7QUFDdkIsVUFBQSxDQUFBLE1BQUEsRUFBYyxFQUFBO0FBRWQsVUFBQSxDQUFBLG1CQUF3QixDQUFBLENBQUE7QUFBQSxLQUFBO0FBRzFCLHVCQUFBLENBQUEsU0FBQSxDQUFvQixDQUFzRTtTQUF0RSxLQUFBLDRDQUFPLEtBQUEsQ0FBQSxJQUFBO1NBQVcsVUFBQSw0Q0FBWSxLQUFBLENBQUEsYUFBQTtTQUFvQixPQUFBLDRDQUFTLEtBQUEsQ0FBQSxJQUFB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LElBQTZCLHNCQUFBLENBQXVCO0FBQ3RELHNCQUFPLFFBQUEsQ0FBQSxXQUFBLENBQUEsWUFBQSxDQUFpQyxDQUFBLENBQUEsQ0FBQSxFQUFBLENBQUEsSUFBQSxJQUFlLGNBQUE7QUFBQSxlQUFBLEtBQ2xELEdBQUEsRUFBSSxPQUFBLENBQUEsV0FBQSxDQUFBLElBQUEsSUFBNkIsc0JBQUEsQ0FBdUI7QUFDN0Qsc0JBQU8sUUFBQSxDQUFBLFdBQUEsQ0FBQSxFQUFBLENBQUEsSUFBQSxJQUFnQyxjQUFBO0FBQUEsZUFBQSxLQUNsQyxHQUFBLEVBQUksT0FBQSxDQUFBLFdBQUEsQ0FBQSxJQUFBLElBQTZCLGNBQUEsQ0FBZTtBQUNyRCxzQkFBTyxRQUFBLENBQUEsV0FBQSxDQUFBLElBQUEsSUFBNkIsY0FBQTtBQUFBO0FBQUE7QUFBQSxXQUFBLENBQUE7QUFJMUMsWUFBQSxFQUFJLENBQUMsUUFBQSxDQUFVO0FBQ2IsaUJBQU0sSUFBSSxNQUFLLEVBQUMsb0JBQUEsRUFBb0IsY0FBQSxFQUFhLFdBQUEsRUFBUyxLQUFBLEVBQUksS0FBQSxDQUFBLENBQUE7QUFBQTtBQUFBLFNBQUEsQ0FBQTtBQUFBO0FBQUE7QUFBQSxHQUFBOzs7QUFPeEUsT0FBQSxDQUFRLFNBQUEsQ0FBQSxFQUFhLFNBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbnZhciBfID0gcmVxdWlyZShcInVuZGVyc2NvcmVcIik7XG52YXIgZnMgPSByZXF1aXJlKFwiZnNcIik7XG52YXIgUGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xudmFyIENvbXBpbGVyID0gcmVxdWlyZShcImVzNi1tb2R1bGUtdHJhbnNwaWxlclwiKS5Db21waWxlcjtcbnZhciBMb2NhbHNDb21waWxlciA9IHJlcXVpcmUoXCIuL2xvY2Fscy1jb21waWxlclwiKVtcImRlZmF1bHRcIl07XG5cbmNsYXNzIFBhY2thZ2VyIHtcbiAgY29uc3RydWN0b3IoZmlsZSwgb3B0aW9ucyA9IHt9KSB7XG4gICAgdGhpcy5yZXF1ZXN0ZWROYW1lID0gZmlsZTtcbiAgICB0aGlzLmZpbGUgPSBQYXRoLnJlc29sdmUoZmlsZSk7XG5cbiAgICB0aGlzLmxvYWRlZE1vZHVsZXMgPSB7fTtcbiAgICB0aGlzLmZpbGVMaXN0ID0gW107XG5cbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuICAgIHRoaXMub3B0aW9ucy5pbXBvcnRzID0ge307XG4gICAgdGhpcy51bmlxdWUgPSAwO1xuXG4gICAgdGhpcy5jb2xsZWN0RGVwZW5kZW5jaWVzKCk7XG4gIH1cblxuICBjb2xsZWN0RGVwZW5kZW5jaWVzKGZpbGUgPSB0aGlzLmZpbGUsIHJlcXVlc3RlZCA9IHRoaXMucmVxdWVzdGVkTmFtZSwgcGFyZW50ID0gdGhpcy5maWxlKSB7XG4gICAgZmlsZSA9IGZpbGUucmVwbGFjZSgvXFwuanMkLywgJycpICsgJy5qcyc7XG5cbiAgICB0aGlzLmxvYWRlZE1vZHVsZXNbZmlsZV0gPSBmYWxzZTtcbiAgICB0aGlzLm9wdGlvbnMuaW1wb3J0c1tmaWxlXSA9IGBfX21vZHVsZSR7dGhpcy51bmlxdWUrK31fX2A7XG5cbiAgICB2YXIgc291cmNlLFxuICAgICAgICBjb21waWxlcjtcblxuICAgIHRyeSB7XG4gICAgICBzb3VyY2UgPSBmcy5yZWFkRmlsZVN5bmMoZmlsZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBsb29rdXAgXCIke3JlcXVlc3RlZH1cIiBmcm9tIFwiJHtwYXJlbnR9XCJgKTtcbiAgICB9XG4gICAgY29tcGlsZXIgPSBuZXcgQ29tcGlsZXIoc291cmNlLCBmaWxlLCB0aGlzLm9wdGlvbnMpO1xuXG4gICAgY29tcGlsZXIuaW1wb3J0cy5mb3JFYWNoKGZ1bmN0aW9uKGltcG9ydFN0YXRlbWVudCkge1xuICAgICAgdmFyIG5hbWUgPSBpbXBvcnRTdGF0ZW1lbnQuc291cmNlLnZhbHVlLFxuICAgICAgICAgIHBhdGggPSBQYXRoLnJlc29sdmUoUGF0aC5kaXJuYW1lKGZpbGUpLCBuYW1lKTtcbiAgICAgIHBhdGggPSBwYXRoLnJlcGxhY2UoL1xcLmpzJC8sICcnKSArICcuanMnO1xuXG4gICAgICBpZiAodGhpcy5sb2FkZWRNb2R1bGVzW3BhdGhdID09PSBmYWxzZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENpcmN1bGFyIGRlcGVuZGVuY3kgZm91bmQgXCIke2ltcG9ydFN0YXRlbWVudC5zb3VyY2UudmFsdWV9XCIgaW4gXCIke2ZpbGV9XCJgKTtcbiAgICAgIH0gZWxzZSBpZiAoIXRoaXMubG9hZGVkTW9kdWxlc1twYXRoXSkge1xuICAgICAgICB0aGlzLmNvbGxlY3REZXBlbmRlbmNpZXMocGF0aCwgbmFtZSwgZmlsZSk7XG4gICAgICAgIHRoaXMuY2hlY2tJbXBvcnRzKHBhdGgsIGltcG9ydFN0YXRlbWVudCk7XG4gICAgICB9XG4gICAgfSwgdGhpcyk7XG5cbiAgICB0aGlzLmxvYWRlZE1vZHVsZXNbZmlsZV0gPSBjb21waWxlcjtcbiAgICB0aGlzLmZpbGVMaXN0LnB1c2goZmlsZSk7XG5cbiAgICByZXR1cm4gdGhpcy5maWxlTGlzdDtcbiAgfVxuXG4gIHRvTG9jYWxzKCkge1xuICAgIHZhciBtb2R1bGVzID0gdGhpcy5sb2FkZWRNb2R1bGVzLFxuICAgICAgICBvcHRpb25zID0gdGhpcy5vcHRpb25zLFxuICAgICAgICByb290ID0gUGF0aC5kaXJuYW1lKHRoaXMuZmlsZSk7XG5cbiAgICB2YXIgb3V0ID0gdGhpcy5vcHRpb25zWydleHBvcnQnXSA/IGAvKiBleHBvcnRlZCAke3RoaXMub3B0aW9uc1snZXhwb3J0J119ICovXFxudGhpcy4ke3RoaXMub3B0aW9uc1snZXhwb3J0J119ID0gYCA6ICcnO1xuICAgIG91dCArPSAnKGZ1bmN0aW9uKCkge1xcbic7XG4gICAgb3V0ICs9IHRoaXMuZmlsZUxpc3QubWFwKGZ1bmN0aW9uKGZpbGUpIHtcbiAgICAgIHZhciBjb21waWxlciA9IG1vZHVsZXNbZmlsZV07XG4gICAgICByZXR1cm4gYC8vICR7UGF0aC5yZWxhdGl2ZShyb290LCBmaWxlKX1cXG4ke25ldyBMb2NhbHNDb21waWxlcihjb21waWxlciwgb3B0aW9ucykuc3RyaW5naWZ5KCl9YDtcbiAgICB9KS5qb2luKCdcXG4nKTtcblxuICAgIGlmICh0aGlzLm9wdGlvbnNbJ2V4cG9ydCddKSB7XG4gICAgICBvdXQgKz0gJ1xcbiAgcmV0dXJuIF9fbW9kdWxlMF9fOyc7XG4gICAgfVxuICAgIG91dCArPSAnXFxufSkoKTtcXG4nO1xuICAgIHJldHVybiBvdXQ7XG4gIH1cblxuICB0b1VNRCgpIHtcbiAgICB2YXIgbW9kdWxlcyA9IHRoaXMubG9hZGVkTW9kdWxlcyxcbiAgICAgICAgb3B0aW9ucyA9IHRoaXMub3B0aW9ucyxcbiAgICAgICAgcm9vdCA9IFBhdGguZGlybmFtZSh0aGlzLmZpbGUpO1xuXG4gICAgdmFyIG91dCA9IHRoaXMub3B0aW9uc1snZXhwb3J0J10gPyBgLyogZXhwb3J0ZWQgJHt0aGlzLm9wdGlvbnNbJ2V4cG9ydCddfSAqL1xuKGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7XG4gIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHtcbiAgICBkZWZpbmUoW10sIGZhY3RvcnkpO1xuICB9IGVsc2UgaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0Jykge1xuICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpO1xuICB9IGVsc2Uge1xuICAgIHJvb3QuJHt0aGlzLm9wdGlvbnNbJ2V4cG9ydCddfSA9IGZhY3RvcnkoKTtcbiAgfVxufSh0aGlzLCBmdW5jdGlvbiAoKSB7XG5gIDogJyhmdW5jdGlvbigpIHtcXG4nO1xuICAgIG91dCArPSB0aGlzLmZpbGVMaXN0Lm1hcChmdW5jdGlvbihmaWxlKSB7XG4gICAgICB2YXIgY29tcGlsZXIgPSBtb2R1bGVzW2ZpbGVdO1xuICAgICAgcmV0dXJuIGAvLyAke1BhdGgucmVsYXRpdmUocm9vdCwgZmlsZSl9XFxuJHtuZXcgTG9jYWxzQ29tcGlsZXIoY29tcGlsZXIsIG9wdGlvbnMpLnN0cmluZ2lmeSgpfWA7XG4gICAgfSkuam9pbignXFxuJyk7XG5cbiAgICBpZiAodGhpcy5vcHRpb25zWydleHBvcnQnXSkge1xuICAgICAgb3V0ICs9ICdcXG4gIHJldHVybiBfX21vZHVsZTBfXztcXG59KSk7XFxuJztcbiAgICB9IGVsc2Uge1xuICAgICAgb3V0ICs9ICdcXG59KSgpO1xcbic7XG4gICAgfVxuICAgIHJldHVybiBvdXQ7XG4gIH1cblxuICBjaGVja0ltcG9ydHMobmFtZSwgaW1wb3J0U3RhdGVtZW50KSB7XG4gICAgdmFyIGltcG9ydGVkID0gdGhpcy5sb2FkZWRNb2R1bGVzW25hbWVdLFxuICAgICAgICBleHBvcnRzID0gaW1wb3J0ZWQuZXhwb3J0cztcblxuICAgIGlmIChpbXBvcnRTdGF0ZW1lbnQua2luZCA9PT0gJ2RlZmF1bHQnKSB7XG4gICAgICBpZiAoIV8uYW55KGV4cG9ydHMsIGZ1bmN0aW9uKGV4cG9ydF8pIHsgcmV0dXJuIGV4cG9ydF9bJ2RlZmF1bHQnXTsgfSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBkZWZhdWx0IGV4cG9ydCBmb3IgXCIke25hbWV9XCJgKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGltcG9ydFN0YXRlbWVudC5raW5kID09PSAnbmFtZWQnKSB7XG4gICAgICBfLmVhY2goaW1wb3J0U3RhdGVtZW50LnNwZWNpZmllcnMsIGZ1bmN0aW9uKHNwZWNpZmllcikge1xuICAgICAgICB2YXIgc3BlY2lmaWVyTmFtZSA9IHNwZWNpZmllci5pZC5uYW1lO1xuXG4gICAgICAgIHZhciBleHBvcnRlZCA9IF8uYW55KGV4cG9ydHMsIGZ1bmN0aW9uKGV4cG9ydF8pIHtcbiAgICAgICAgICBpZiAoZXhwb3J0Xy5zcGVjaWZpZXJzKSB7XG4gICAgICAgICAgICByZXR1cm4gXy5hbnkoZXhwb3J0Xy5zcGVjaWZpZXJzLCBmdW5jdGlvbihleHBvcnRTcGVjaWZpZXIpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGV4cG9ydFNwZWNpZmllci5pZC5uYW1lID09PSBzcGVjaWZpZXJOYW1lO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIGlmIChleHBvcnRfLmRlY2xhcmF0aW9uKSB7XG4gICAgICAgICAgICBpZiAoZXhwb3J0Xy5kZWNsYXJhdGlvbi50eXBlID09PSAnVmFyaWFibGVEZWNsYXJhdGlvbicpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGV4cG9ydF8uZGVjbGFyYXRpb24uZGVjbGFyYXRpb25zWzBdLmlkLm5hbWUgPT09IHNwZWNpZmllck5hbWU7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGV4cG9ydF8uZGVjbGFyYXRpb24udHlwZSA9PT0gJ0Z1bmN0aW9uRGVjbGFyYXRpb24nKSB7XG4gICAgICAgICAgICAgIHJldHVybiBleHBvcnRfLmRlY2xhcmF0aW9uLmlkLm5hbWUgPT09IHNwZWNpZmllck5hbWU7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGV4cG9ydF8uZGVjbGFyYXRpb24udHlwZSA9PT0gJ0luZGVudGlmaWVyJykge1xuICAgICAgICAgICAgICByZXR1cm4gZXhwb3J0Xy5kZWNsYXJhdGlvbi5uYW1lID09PSBzcGVjaWZpZXJOYW1lO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGlmICghZXhwb3J0ZWQpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIGV4cG9ydCBuYW1lZCBcIiR7c3BlY2lmaWVyTmFtZX1cIiBpbiBcIiR7bmFtZX1cImApO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0c1tcImRlZmF1bHRcIl0gPSBQYWNrYWdlcjsiXX0=