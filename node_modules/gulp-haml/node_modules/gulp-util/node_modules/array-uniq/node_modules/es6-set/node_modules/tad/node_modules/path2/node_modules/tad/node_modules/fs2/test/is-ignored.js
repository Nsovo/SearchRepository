'use strict';

var fs        = require('fs')
  , resolve   = require('path').resolve
  , noop      = require('es5-ext/lib/Function/noop')
  , deferred  = require('deferred')
  , delay     = deferred.delay
  , promisify = deferred.promisify
  , mkdir     = promisify(fs.mkdir)
  , writeFile = promisify(fs.writeFile)
  , unlink    = promisify(fs.unlink)
  , rmdir     = promisify(fs.rmdir)
  , modes     = require('../lib/_ignore-modes')

  , pgPath = resolve(__dirname, './__playground/is-ignored');

module.exports = function (t, a, d) {
	var invoked = null, listener, testIsRoot
	  , DELAY = 100
	  , gitRoot = resolve(pgPath, '.git')
	  , rootFile = resolve(pgPath, '.gitignore')
	  , onePath = resolve(pgPath, 'one')
	  , oneFile = resolve(onePath, '.gitignore')
	  , twoPath = resolve(onePath, 'two')
	  , twoFile = resolve(twoPath, '.gitignore')
	  , twoOtherFile = resolve(twoPath, '.ignore')
	  , twoFooPath = resolve(twoPath, 'foo')

	  , watcher;

	modes.test = {
		filename: '.ignore',
		isRoot: testIsRoot = function (path) {
			var promise = deferred(path === onePath);
			promise.close = noop;
			return promise;
		},
		isRootWatcher: testIsRoot
	};

	deferred(mkdir(gitRoot), mkdir(onePath)(function () {
		return mkdir(twoPath);
	}))(delay(function () {
		t('git', resolve(gitRoot, 'foo/bar'))(function (value) {
			a(value, true, "Ignore gitrepo file");
		}).end();
		watcher = t('git', twoFooPath, { watch: true });
		watcher.on('change', listener = function (arg) {
			a(invoked, null, "Invoked once");
			invoked = arg;
		});
		watcher.end();
		return t('git', twoFooPath);
	}, DELAY))(delay(function (value) {
		a(value, false, "#1");
		return writeFile(rootFile, 'foo');
	}, DELAY))(delay(function () {
		a(invoked, true, "#2 event");
		invoked = null;
		return t('git', twoFooPath);
	}, DELAY))(function (value) {
		a(value, true, "#2");
		return writeFile(oneFile, '/two/foo');
	})(delay(function () {
		a(invoked, null, "#3 event");
		return t('git', twoFooPath);
	}, DELAY))(function (value) {
		a(value, true, "#3");
		return writeFile(twoFile, '!foo');
	})(delay(function () {
		a(invoked, false, "#4 event");
		invoked = null;
		return t('git', twoFooPath);
	}, DELAY))(function (value) {
		a(value, false, "#4");
		return deferred(unlink(rootFile), unlink(oneFile));
	})(delay(function () {
		a(invoked, null, "#5 event");
		return t('git', twoFooPath);
	}, DELAY))(function (value) {
		a(value, false, "#5");
		return unlink(twoFile);
	})(delay(function () {
		a(invoked, null, "#6 event");
		invoked = null;
		return t('git', twoFooPath);
	}, DELAY))(function (value) {
		a(value, false, "#6");
		return writeFile(oneFile, '/two/foo\n!/two/foo');
	})(delay(function () {
		a(invoked, null, "#7 event");
		invoked = null;
		return t('git', twoFooPath);
	}, DELAY))(function (value) {
		a(value, false, "#7");
		return writeFile(rootFile, 'two');
	})(delay(function () {
		a(invoked, true, "#8 event");
		invoked = null;
		return t('git', twoFooPath);
	}, DELAY))(function (value) {
		a(value, true, "#8");
		return unlink(rootFile);
	})(delay(function () {
		a(invoked, false, "#9 event");
		invoked = null;
		return t('git', twoFooPath);
	}, DELAY))(function (value) {
		a(value, false, "#9");
		return writeFile(rootFile, '/one');
	})(delay(function () {
		a(invoked, true, "#10 event");
		invoked = null;
		return t('git', twoFooPath);
	}, DELAY))(function (value) {
		a(value, true, "#10");
		watcher.close();
		return deferred(writeFile(rootFile, 'one\n!one/two/foo'), unlink(oneFile));
	})(delay(function () {
		a(invoked, null, "#11 event");
		in