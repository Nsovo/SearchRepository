#!/usr/bin/env node

var path   = require('path'),
    fs     = require('fs'),
    util   = require('util'),
    events = require('events');

//
// Attempt to load Coffee-Script. If it's not available, continue on our
// merry way, if it is available, set it up so we can include `*.coffee`
// scripts and start searching for them.
//
var fileExt, specFileExt;

try {
    var coffee = require('coffee-script');
    if (require.extensions) {
        require.extensions['.coffee'] = function (module, filename) {
            var content = coffee.compile(fs.readFileSync(filename, 'utf8'));
            return module._compile(content, filename);
        };
    } else {
        require.registerExtension('.coffee', function (content) { return coffee.compile(content) });
    }
    fileExt     = /\.(js|coffee)$/;
    specFileExt = /[.-](test|spec)\.(js|coffee)$/;
} catch (_) {
    fileExt     = /\.js$/;
    specFileExt = /[.-](test|spec)\.js$/;
}

var inspect = require('eyes').inspector({
    stream: null,
    styles: { string: 'grey', regexp: 'grey' }
});

var vows = require('../lib/vows');
var cutils = require('../lib/vows/console');
var stylize = require('../lib/vows/console').stylize;
var _reporter = require('../lib/vows/reporters/dot-matrix'), reporter = {
    name: _reporter.name
};
var _coverage;

var help = [
    "usage: vows [FILE, ...] [options]",
    "",
    "options:",
    "  -v, --verbose     Enable verbose output",
    "  -w, --watch       Watch mode",
    "  -s, --silent      Don't report",
    "  -i, --isolate     Run each test in it's own vows process",
    "  -m  PATTERN       Only run tests matching the PATTERN string",
    "  -r  PATTERN       Only run tests matching the PATTERN regexp",
    "  --json            Use JSON reporter",
    "  --spec            Use Spec reporter",
    "  --dot-matrix      Use Dot-Matrix reporter",
    "  --xunit           Use xUnit reporter",
    "  --cover-plain     Print plain coverage map if detected",
    "  --cover-html      Write coverage map to \"coverage.html\"",
    "  --cover-json      Write unified coverage map to \"coverage.json\"",
    //"  --no-color        Don't use terminal colors",
    "  --version         Show version",
    "  -h, --help        You're staring at it"
].join('\n');

var options = {
    reporter: reporter,
    matcher: /.*/,
    watch: false,
    coverage: false,
    isolate: false
};

var files = [];

// Get rid of process runner
// ('node' in most cases)
var arg, args = [], argv = process.argv.slice(2);

// Current directory index,
// and path of test folder.
var root, testFolder;

//
// Parse command-line parameters
//
while (arg = argv.shift()) {
    if (arg === __filename) { continue }

    if (arg[0] !== '-') {
        args.push(arg);
    } else {
        arg = arg.match(/^--?(.+)/)[1];

        if (arg[0] === 'r') {
            options.matcher = new(RegExp)(argv.shift());
        } else if (arg[0] === 'm') {
            options.matcher = (function (str) { // Create an escaped RegExp
                var specials = '. * + ? | ( ) [ ] { } \\ ^ ? ! = : $'.split(' ').join('|\\'),
                    regex    = new(RegExp)('(\\' + specials + ')', 'g');
                return new(RegExp)(str.replace(regex, '\\$1'));
            })(argv.shift());
        } else if (arg in options) {
            options[arg] = true;
        } else {
            switch (arg) {
                case 'json':
                    _reporter = require('../lib/vows/reporters/json');
                    break;
                case 'spec':
                    _reporter = require('../lib/vows/reporters/spec');
                    break;
                case 'dot-matrix':
                    _reporter = require('../lib/vows/reporters/dot-matrix');
                    break;
                case 'silent':
                case 's':
                    _reporter = require('../lib/vows/reporters/silent');
                    break;
                case 'xunit':
                    _reporter = require('../lib/vows/reporters/xunit');
                    break;
                case 'cover-plain':
                    options.coverage = true;
                    _coverage = require('../lib/vows/coverage/report-plain');
                    break;
                case 'cover-html':
                    options.coverage = true;
                    _coverage = require('../lib/vows/coverage/report-html');
                    break;
                case 'cover-json':
                    options.coverage = true;
                    _coverage = require('../lib/vows/coverage/report-json');
                    break;
                case 'verbose':
                case 'v':
                    options.verbose = true;
                    break;
                case 'watch':
                case 'w':
                    options.watch = true;
                    break;
                case 'supress-stdout':
                    options.supressStdout = true;
                    break;
                case 'isolate':
                case 'i':
                    options.isolate = true;
                    break;
                case 'no-color':
                    options.nocolor = true;
                    break;
                case 'no-error':
                    options.error = false;
                    break;
                case 'version':
                    console.log('vows ' + vows.version);
                    process.exit(0);
                case 'help':
                case 'h':
                    console.log(help);
                    process.exit(0);
                    break;
            }
        }
    }
}

if (options.supressStdout) {
    _reporter.setStream && _reporter.setStream(process.stdout);
    var devNullStream = fs.createWriteStream('/dev/null');
    process.__defineGetter__('stdout', function () {
        return devNullStream;
    });
}

if (options.watch) {
    options.reporter = reporter = require('../lib/vows/reporters/watch');
}

msg('bin', 'argv', args);
msg('bin', 'options', { reporter: options.reporter.name, matcher: options.matcher });

if (args.length === 0 || options.watch) {
    msg('bin', 'discovering', 'folder structure');
    root = fs.readdirSync('.');

    if (root.indexOf('test') !== -1) {
        testFolder = 'test';
    } else if (root.indexOf('spec') !== -1) {
        testFolder = 'spec';
    } else {
        abort("runner", "couldn't find test folder");
    }
    msg('bin', 'discovered', "./" + testFolder);

    if (args.length === 0) {
        args = paths(testFolder).filter(function (f) {
            return new(RegExp)('-' + testFolder + '.(js|coffee)$').test(f);
       