"use strict";
var $__Object = Object,
    $__getOwnPropertyNames = $__Object.getOwnPropertyNames,
    $__getOwnPropertyDescriptor = $__Object.getOwnPropertyDescriptor,
    $__getDescriptors = function(object) {
      var descriptors = {},
          name,
          names = $__getOwnPropertyNames(object);
      for (var i = 0; i < names.length; i++) {
        var name = names[i];
        descriptors[name] = $__getOwnPropertyDescriptor(object, name);
      }
      return descriptors;
    },
    $__createClassNoExtends = function(object, staticObject) {
      var ctor = object.constructor;
      Object.defineProperty(object, 'constructor', {enumerable: false});
      ctor.prototype = object;
      Object.defineProperties(ctor, $__getDescriptors(staticObject));
      return ctor;
    };
var _ = require("underscore");
var fs = require("fs");
var Path = require("path");
var Compiler = require("es6-module-transpiler").Compiler;
var LocalsCompiler = require("./locals-compiler")["default"];
var Packager = function() {
  'use strict';
  var $Packager = ($__createClassNoExtends)({
    constructor: function(file) {
      var options = arguments[1] !== (void 0) ? arguments[1]: {};
      this.file = Path.resolve(file);
      this.loadedModules = {};
      this.fileList = [];
      this.options = options;
      this.options.imports = {};
      this.unique = 0;
      this.collectDependencies();
    },
    collectDependencies: function() {
      var file = arguments[0] !== (void 0) ? arguments[0]: this.file;
      file = file.replace(/\.js$/, '') + '.js';
      this.loadedModules[file] = false;
      this.options.imports[file] = ("__module" + this.unique++ + "__");
      var source = fs.readFileSync(file);
      var compiler = new Compiler(source, file, this.options);
      compiler.imports.forEach(function(importStatement) {
        var name = importStatement.source.value;
        name = Path.resolve(Path.dirname(file), name);
        name = name.replace(/\.js$/, '') + '.js';
        if (this.loadedModules[name] === false) {
          throw new Error(("Circular dependency found \"" + importStatement.source.value + "\" in \"" + file + "\""));
        } else if (!this.loadedModules[name]) {
          this.collectDependencies(name);
          this.checkImports(name, importStatement);
        }
      }, this);
      this.loadedModules[file] = compiler;
      this.fileList.push(file);
      return this.fileList;
    },
    toLocals: function() {
      var modules = this.loadedModules,
          options = this.options,
          root = Path.dirname(this.file);
      var out = this.options['export'] ? ("/* exported " + this.options['export'] + " */\nvar " + this.options['export'] + " = "): '';
      out += '(function() {\n';
      out += this.fileList.map(function(file) {
        var compiler = modules[file];
        return ("// " + Path.relative(root, file) + "\n" + new LocalsCompiler(compiler, options).stringify());
      }).join('\n');
      if (this.options['export']) {
        out += '\n  return __module0__;';
      }
      out += '\n})();\n';
      return out;
    },
    checkImports: function(name, importStatement) {
      var imported = this.loadedModules[name],
          exports = imported.exports;
      if (importStatement.kind === 'default') {
        if (!_.any(exports, function(export_) {
          return export_['default'];
        })) {
          throw new Error(("No default export for \"" + name + "\""));
        }
      } else if (importStatement.kind === 'named') {
        _.each(importStatement.specifiers, function(specifier) {
          var specifierName = specifier.id.name;
          var exported = _.any(exports, function(export_) {
            if (export_.specifiers) {
              return _.any(export_.specifiers, function(exportSpecifier) {
                return exportSpecifier.id.name === specifierName;
              });
            } else if (export_.declaration) {
              if (export_.declaration.type === 'VariableDeclaration') {
                return export_.declaration.declarations[0].id.name === specifierName;
              } else if (export_.declaration.type === 'FunctionDeclaration') {
                return export_.declaration.id.name === specifierName;
              } else if (export_.declaration.type === 'Indentifier') {
                return export_.declaration.name === specifierName;
              }
            }
          });
          if (!exported) {
            throw new Error(("No export named \"" + specifierName + "\" in \"" + name + "\""));
          }
        });
      }
    }
  }, {});
  return $Packager;
}();
exports["default"] = Packager;

//@ sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG1wL3RyYW5zcGlsZWQvbGliL3BhY2thZ2VyLmpzLmVzNiIsInNvdXJjZXMiOlsidG1wL3RyYW5zcGlsZWQvbGliL3BhY2thZ2VyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUNJLEdBQUEsRUFBQSxFQUFJLFFBQU8sQ0FBQyxZQUFBLENBQUE7QUFDWixHQUFBLEdBQUEsRUFBSyxRQUFPLENBQUMsSUFBQSxDQUFBO0FBQ2IsR0FBQSxLQUFBLEVBQU8sUUFBTyxDQUFDLE1BQUEsQ0FBQTtBQUNmLEdBQUEsU0FBQSxFQUFXLFFBQU8sQ0FBQyx1QkFBQSxDQUFBLENBQUEsUUFBQTtBQUNuQixHQUFBLGVBQUEsRUFBaUIsUUFBTyxDQUFDLG1CQUFBLENBQUEsQ0FBcUIsU0FBQSxDQUFBO0dBRTVDLFNBQUE7OztBQUNKLGVBQUEsQ0FBQSxTQUFBLENBQVksSUFBQSxDQUFvQjtTQUFkLFFBQUEsNENBQVUsRUFBQSxDQUFBO0FBQzFCLFVBQUEsQ0FBQSxJQUFBLEVBQVksS0FBQSxDQUFBLE9BQVksQ0FBQyxJQUFBLENBQUE7QUFFekIsVUFBQSxDQUFBLGFBQUEsRUFBcUIsRUFBQSxDQUFBO0FBQ3JCLFVBQUEsQ0FBQSxRQUFBLEVBQWdCLEVBQUEsQ0FBQTtBQUVoQixVQUFBLENBQUEsT0FBQSxFQUFlLFFBQUE7QUFDZixVQUFBLENBQUEsT0FBQSxDQUFBLE9BQUEsRUFBdUIsRUFBQSxDQUFBO0FBQ3ZCLFVBQUEsQ0FBQSxNQUFBLEVBQWMsRUFBQTtBQUVkLFVBQUEsQ0FBQSxtQkFBd0IsQ0FBQSxDQUFBO0FBQUEsS0FBQTtBQUcxQix1QkFBQSxDQUFBLFNBQUEsQ0FBb0IsQ0FBa0I7U0FBbEIsS0FBQSw0Q0FBTyxLQUFBLENBQUEsSUFBQTtBQUN6QixVQUFBLEVBQU8sS0FBQSxDQUFBLE9BQVksQ0FBQyxPQUFBLENBQVMsR0FBQSxDQUFBLEVBQU0sTUFBQTtBQUVuQyxVQUFBLENBQUEsYUFBQSxDQUFtQixJ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QSxlQUFBLEtBQ2xELEdBQUEsRUFBSSxPQUFBLENBQUEsV0FBQSxDQUFBLElBQUEsSUFBNkIsc0JBQUEsQ0FBdUI7QUFDN0Qsc0JBQU8sUUFBQSxDQUFBLFdBQUEsQ0FBQSxFQUFBLENBQUEsSUFBQSxJQUFnQyxjQUFBO0FBQUEsZUFBQSxLQUNsQyxHQUFBLEVBQUksT0FBQSxDQUFBLFdBQUEsQ0FBQSxJQUFBLElBQTZCLGNBQUEsQ0FBZTtBQUNyRCxzQkFBTyxRQUFBLENBQUEsV0FBQSxDQUFBLElBQUEsSUFBNkIsY0FBQTtBQUFBO0FBQUE7QUFBQSxXQUFBLENBQUE7QUFJMUMsWUFBQSxFQUFJLENBQUMsUUFBQSxDQUFVO0FBQ2IsaUJBQU0sSUFBSSxNQUFLLEVBQUMsb0JBQUEsRUFBb0IsY0FBQSxFQUFhLFdBQUEsRUFBUyxLQUFBLEVBQUksS0FBQSxDQUFBLENBQUE7QUFBQTtBQUFBLFNBQUEsQ0FBQTtBQUFBO0FBQUE7QUFBQSxHQUFBOzs7QUFPeEUsT0FBQSxDQUFRLFNBQUEsQ0FBQSxFQUFhLFNBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbnZhciBfID0gcmVxdWlyZShcInVuZGVyc2NvcmVcIik7XG52YXIgZnMgPSByZXF1aXJlKFwiZnNcIik7XG52YXIgUGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xudmFyIENvbXBpbGVyID0gcmVxdWlyZShcImVzNi1tb2R1bGUtdHJhbnNwaWxlclwiKS5Db21waWxlcjtcbnZhciBMb2NhbHNDb21waWxlciA9IHJlcXVpcmUoXCIuL2xvY2Fscy1jb21waWxlclwiKVtcImRlZmF1bHRcIl07XG5cbmNsYXNzIFBhY2thZ2VyIHtcbiAgY29uc3RydWN0b3IoZmlsZSwgb3B0aW9ucyA9IHt9KSB7XG4gICAgdGhpcy5maWxlID0gUGF0aC5yZXNvbHZlKGZpbGUpO1xuXG4gICAgdGhpcy5sb2FkZWRNb2R1bGVzID0ge307XG4gICAgdGhpcy5maWxlTGlzdCA9IFtdO1xuXG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcbiAgICB0aGlzLm9wdGlvbnMuaW1wb3J0cyA9IHt9O1xuICAgIHRoaXMudW5pcXVlID0gMDtcblxuICAgIHRoaXMuY29sbGVjdERlcGVuZGVuY2llcygpO1xuICB9XG5cbiAgY29sbGVjdERlcGVuZGVuY2llcyhmaWxlID0gdGhpcy5maWxlKSB7XG4gICAgZmlsZSA9IGZpbGUucmVwbGFjZSgvXFwuanMkLywgJycpICsgJy5qcyc7XG5cbiAgICB0aGlzLmxvYWRlZE1vZHVsZXNbZmlsZV0gPSBmYWxzZTtcbiAgICB0aGlzLm9wdGlvbnMuaW1wb3J0c1tmaWxlXSA9IGBfX21vZHVsZSR7dGhpcy51bmlxdWUrK31fX2A7XG5cbiAgICB2YXIgc291cmNlID0gZnMucmVhZEZpbGVTeW5jKGZpbGUpO1xuICAgIHZhciBjb21waWxlciA9IG5ldyBDb21waWxlcihzb3VyY2UsIGZpbGUsIHRoaXMub3B0aW9ucyk7XG5cbiAgICBjb21waWxlci5pbXBvcnRzLmZvckVhY2goZnVuY3Rpb24oaW1wb3J0U3RhdGVtZW50KSB7XG4gICAgICB2YXIgbmFtZSA9IGltcG9ydFN0YXRlbWVudC5zb3VyY2UudmFsdWU7XG4gICAgICBuYW1lID0gUGF0aC5yZXNvbHZlKFBhdGguZGlybmFtZShmaWxlKSwgbmFtZSk7XG4gICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKC9cXC5qcyQvLCAnJykgKyAnLmpzJztcblxuICAgICAgaWYgKHRoaXMubG9hZGVkTW9kdWxlc1tuYW1lXSA9PT0gZmFsc2UpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDaXJjdWxhciBkZXBlbmRlbmN5IGZvdW5kIFwiJHtpbXBvcnRTdGF0ZW1lbnQuc291cmNlLnZhbHVlfVwiIGluIFwiJHtmaWxlfVwiYCk7XG4gICAgICB9IGVsc2UgaWYgKCF0aGlzLmxvYWRlZE1vZHVsZXNbbmFtZV0pIHtcbiAgICAgICAgdGhpcy5jb2xsZWN0RGVwZW5kZW5jaWVzKG5hbWUpO1xuICAgICAgICB0aGlzLmNoZWNrSW1wb3J0cyhuYW1lLCBpbXBvcnRTdGF0ZW1lbnQpO1xuICAgICAgfVxuICAgIH0sIHRoaXMpO1xuXG4gICAgdGhpcy5sb2FkZWRNb2R1bGVzW2ZpbGVdID0gY29tcGlsZXI7XG4gICAgdGhpcy5maWxlTGlzdC5wdXNoKGZpbGUpO1xuXG4gICAgcmV0dXJuIHRoaXMuZmlsZUxpc3Q7XG4gIH1cblxuICB0b0xvY2FscygpIHtcbiAgICB2YXIgbW9kdWxlcyA9IHRoaXMubG9hZGVkTW9kdWxlcyxcbiAgICAgICAgb3B0aW9ucyA9IHRoaXMub3B0aW9ucyxcbiAgICAgICAgcm9vdCA9IFBhdGguZGlybmFtZSh0aGlzLmZpbGUpO1xuXG4gICAgdmFyIG91dCA9IHRoaXMub3B0aW9uc1snZXhwb3J0J10gPyBgLyogZXhwb3J0ZWQgJHt0aGlzLm9wdGlvbnNbJ2V4cG9ydCddfSAqL1xcbnZhciAke3RoaXMub3B0aW9uc1snZXhwb3J0J119ID0gYCA6ICcnO1xuICAgIG91dCArPSAnKGZ1bmN0aW9uKCkge1xcbic7XG4gICAgb3V0ICs9IHRoaXMuZmlsZUxpc3QubWFwKGZ1bmN0aW9uKGZpbGUpIHtcbiAgICAgIHZhciBjb21waWxlciA9IG1vZHVsZXNbZmlsZV07XG4gICAgICByZXR1cm4gYC8vICR7UGF0aC5yZWxhdGl2ZShyb290LCBmaWxlKX1cXG4ke25ldyBMb2NhbHNDb21waWxlcihjb21waWxlciwgb3B0aW9ucykuc3RyaW5naWZ5KCl9YDtcbiAgICB9KS5qb2luKCdcXG4nKTtcblxuICAgIGlmICh0aGlzLm9wdGlvbnNbJ2V4cG9ydCddKSB7XG4gICAgICBvdXQgKz0gJ1xcbiAgcmV0dXJuIF9fbW9kdWxlMF9fOyc7XG4gICAgfVxuICAgIG91dCArPSAnXFxufSkoKTtcXG4nO1xuICAgIHJldHVybiBvdXQ7XG4gIH1cblxuICBjaGVja0ltcG9ydHMobmFtZSwgaW1wb3J0U3RhdGVtZW50KSB7XG4gICAgdmFyIGltcG9ydGVkID0gdGhpcy5sb2FkZWRNb2R1bGVzW25hbWVdLFxuICAgICAgICBleHBvcnRzID0gaW1wb3J0ZWQuZXhwb3J0cztcblxuICAgIGlmIChpbXBvcnRTdGF0ZW1lbnQua2luZCA9PT0gJ2RlZmF1bHQnKSB7XG4gICAgICBpZiAoIV8uYW55KGV4cG9ydHMsIGZ1bmN0aW9uKGV4cG9ydF8pIHsgcmV0dXJuIGV4cG9ydF9bJ2RlZmF1bHQnXTsgfSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBkZWZhdWx0IGV4cG9ydCBmb3IgXCIke25hbWV9XCJgKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGltcG9ydFN0YXRlbWVudC5raW5kID09PSAnbmFtZWQnKSB7XG4gICAgICBfLmVhY2goaW1wb3J0U3RhdGVtZW50LnNwZWNpZmllcnMsIGZ1bmN0aW9uKHNwZWNpZmllcikge1xuICAgICAgICB2YXIgc3BlY2lmaWVyTmFtZSA9IHNwZWNpZmllci5pZC5uYW1lO1xuXG4gICAgICAgIHZhciBleHBvcnRlZCA9IF8uYW55KGV4cG9ydHMsIGZ1bmN0aW9uKGV4cG9ydF8pIHtcbiAgICAgICAgICBpZiAoZXhwb3J0Xy5zcGVjaWZpZXJzKSB7XG4gICAgICAgICAgICByZXR1cm4gXy5hbnkoZXhwb3J0Xy5zcGVjaWZpZXJzLCBmdW5jdGlvbihleHBvcnRTcGVjaWZpZXIpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGV4cG9ydFNwZWNpZmllci5pZC5uYW1lID09PSBzcGVjaWZpZXJOYW1lO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIGlmIChleHBvcnRfLmRlY2xhcmF0aW9uKSB7XG4gICAgICAgICAgICBpZiAoZXhwb3J0Xy5kZWNsYXJhdGlvbi50eXBlID09PSAnVmFyaWFibGVEZWNsYXJhdGlvbicpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGV4cG9ydF8uZGVjbGFyYXRpb24uZGVjbGFyYXRpb25zWzBdLmlkLm5hbWUgPT09IHNwZWNpZmllck5hbWU7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGV4cG9ydF8uZGVjbGFyYXRpb24udHlwZSA9PT0gJ0Z1bmN0aW9uRGVjbGFyYXRpb24nKSB7XG4gICAgICAgICAgICAgIHJldHVybiBleHBvcnRfLmRlY2xhcmF0aW9uLmlkLm5hbWUgPT09IHNwZWNpZmllck5hbWU7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGV4cG9ydF8uZGVjbGFyYXRpb24udHlwZSA9PT0gJ0luZGVudGlmaWVyJykge1xuICAgICAgICAgICAgICByZXR1cm4gZXhwb3J0Xy5kZWNsYXJhdGlvbi5uYW1lID09PSBzcGVjaWZpZXJOYW1lO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGlmICghZXhwb3J0ZWQpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIGV4cG9ydCBuYW1lZCBcIiR7c3BlY2lmaWVyTmFtZX1cIiBpbiBcIiR7bmFtZX1cImApO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0c1tcImRlZmF1bHRcIl0gPSBQYWNrYWdlcjsiXX0=